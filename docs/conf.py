# Configuration file for the Sphinx documentation builder.
#
# This file only contains a selection of the most common options. For a full
# list see the documentation:
# https://www.sphinx-doc.org/en/master/usage/configuration.html

# -- Path setup --------------------------------------------------------------

# If extensions (or modules to document with autodoc) are in another directory,
# add these directories to sys.path here. If the directory is relative to the
# documentation root, use os.path.abspath to make it absolute, like shown here.
#
import inspect
import os
import re
import sys
from os.path import dirname, relpath

import git

root = os.path.abspath('..')

sys.path.insert(0, root)

# -- Project information -----------------------------------------------------

project = 'Open edX Events'
copyright = '2023, Open edX Community'
author = 'Open edX Community'

# The full version, including alpha/beta/rc tags
release = 'latest'


# -- General configuration ---------------------------------------------------

# Add any Sphinx extension module names here, as strings. They can be
# extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
# ones.
extensions = [
    'sphinxcontrib.contentui',
    'sphinx_copybutton',
    'sphinx.ext.graphviz',
    'sphinxcontrib.mermaid',
    'code_annotations.contrib.sphinx.extensions.openedx_events',
    'sphinx.ext.intersphinx',
    'code_annotations.contrib.sphinx.extensions.settings',
    'sphinx.ext.autodoc',
    'sphinx.ext.autosummary',
    'sphinx.ext.napoleon',
    'sphinx.ext.linkcode',
]

# Add any paths that contain templates here, relative to this directory.
templates_path = ['_templates']

# The language for content autogenerated by Sphinx. Refer to documentation
# for a list of supported languages.
#
# This is also used if you do content translation via gettext catalogs.
# Usually you set "language" from the command line for these cases.
language = 'en'

# List of patterns, relative to source directory, that match files and
# directories to ignore when looking for source files.
# This pattern also affects html_static_path and html_extra_path.
exclude_patterns = ['_build', 'Thumbs.db', '.DS_Store']


# -- Options for HTML output -------------------------------------------------

# The theme to use for HTML and HTML Help pages.  See the documentation for
# a list of builtin themes.
#
html_theme = 'sphinx_book_theme'

html_theme_options = {
    "repository_url": "https://github.com/openedx/openedx-events",
    "repository_branch": "main",
    "path_to_docs": "docs/",
    "use_repository_button": True,
    "use_issues_button": True,
    "use_edit_page_button": True,
    "extra_footer": """
        <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
            <img
                alt="Creative Commons License"
                style="border-width:0"
                src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png">
        </a>
        <br>
        These works by
            <a
                xmlns:cc="https://creativecommons.org/ns#"
                href="https://openedx.org"
                property="cc:attributionName"
                rel="cc:attributionURL"
            >Axim Collaborative</a>
        are licensed under a
            <a
                rel="license"
                href="https://creativecommons.org/licenses/by-sa/4.0/"
            >Creative Commons Attribution-ShareAlike 4.0 International License</a>.
    """
}

# Note the logo won't show up properly yet because there is an upstream
# bug in the theme that needs to be fixed first.
# If you'd like you can temporarily copy the logo file to your `_static`
# directory.
html_logo = "https://logos.openedx.org/open-edx-logo-color.png"
html_favicon = "https://logos.openedx.org/open-edx-favicon.ico"

# Add any paths that contain custom static files (such as style sheets) here,
# relative to this directory. They are copied after the builtin static files,
# so a file named "default.css" will overwrite the builtin "default.css".
html_static_path = ['_static']


# -- Read the Docs Specific Configuration
# Define the canonical URL if you are using a custom domain on Read the Docs
html_baseurl = os.environ.get("READTHEDOCS_CANONICAL_URL", "")

# Tell Jinja2 templates the build is running on Read the Docs
if os.environ.get("READTHEDOCS", "") == "True":
    if "html_context" not in globals():
        html_context = {}
    html_context["READTHEDOCS"] = True

# -- Extension configuration -------------------------------------------------

# Intersphinx Extension Configuration
DIGITS_ONLY = r"^\d+$"
rtd_language = os.environ.get("READTHEDOCS_LANGUAGE", "en")
rtd_version = os.environ.get("READTHEDOCS_VERSION", "latest")
if re.search(DIGITS_ONLY, rtd_version):
    # This is a PR build, use the latest versions of the other repos.
    rtd_version = "latest"

intersphinx_mapping = {
    "docs.openedx.org": (
        f"https://docs.openedx.org/{rtd_language}/{rtd_version}",
        None,
    ),
    "openedx-proposals": (
        # Not setting the version on purpose because we always want the latest version
        # of OEPs
        f"https://docs.openedx.org/projects/openedx-proposals/{rtd_language}/latest",
        None,
    ),
}

# Code Annotations Related Configurations

try:
    openedx_event_version = git.Repo(search_parent_directories=True).head.object.hexsha
except git.InvalidGitRepositoryError:
    openedx_event_version = "main"

settings_source_path = str(root)
settings_repo_url = "https://github.com/openedx/openedx-events"
settings_repo_version = openedx_event_version
openedxevents_repo_url = settings_repo_url

# Linkcode Extension Configuration

REPO_URL = "https://github.com/openedx/openedx-events/blob/main"

def linkcode_resolve(domain: str, info: dict[str, str]) -> str | None:
    """
    Resolves source code links for Python objects in Sphinx documentation.
    This function is based on the `linkcode_resolve` function in the SciPy project.

    Args:
        domain (str): The language domain of the object. Only processes Python objects ('py')
        info (dict[str, str]): Dictionary containing information about the object to link.
            Must contain:
                - 'module': Name of the module containing the object
                - 'fullname': Complete name of the object including its path

    Returns:
        str | None: URL to the source code on GitHub with specific line numbers,
            or None if the link cannot be resolved
    """
    if domain != "py":
        return None

    modname = info["module"]
    fullname = info["fullname"]

    submod = sys.modules.get(modname)
    if submod is None:
        return None

    obj = submod
    for part in fullname.split("."):
        try:
            obj = getattr(obj, part)
        except Exception:
            return None

    # Use the original function object if it is wrapped.
    while hasattr(obj, "__wrapped__"):
        obj = obj.__wrapped__

    # Get the file path where the object is defined
    try:
        # Try to get the file path of the object directly
        file_path = inspect.getsourcefile(obj)
    except Exception:
        try:
            # If that fails, try to get the file path of the module where the object is defined
            file_path = inspect.getsourcefile(sys.modules[obj.__module__])
        except Exception:
            # If both attempts fail, set file_path to None
            file_path = None
    if not file_path:
        return None

    try:
        source, start_line = inspect.getsourcelines(obj)
    except Exception:
        start_line = None

    if start_line:
        linespec = f"#L{start_line}-L{start_line + len(source) - 1}"
    else:
        linespec = ""

    import openedx_events

    start_dir = os.path.abspath(os.path.join(dirname(openedx_events.__file__), ".."))
    file_path = relpath(file_path, start=start_dir).replace(os.path.sep, "/")

    return f"{REPO_URL}/{file_path}{linespec}"
